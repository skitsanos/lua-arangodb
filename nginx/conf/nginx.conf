# OpenResty configuration for lua-arangodb testing
# This configuration sets up OpenResty to run Lua tests against ArangoDB

# Environment variables to expose to Lua
env ARANGO_ENDPOINT;
env ARANGO_USERNAME;
env ARANGO_PASSWORD;
env ARANGO_DATABASE;
env OPENAI_API_KEY;

worker_processes auto;
error_log /dev/stderr info;
pid /tmp/nginx.pid;

events {
    worker_connections 1024;
}

http {
    # Lua package paths - include our arangodb module
    lua_package_path '/usr/local/openresty/lualib/?.lua;/usr/local/share/lua/5.1/?.lua;/app/src/?.lua;/app/src/?/init.lua;;';
    lua_package_cpath '/usr/local/openresty/lualib/?.so;/usr/local/lib/lua/5.1/?.so;;';

    # DNS resolver for lua-resty-http (use container's internal DNS)
    # For Docker: 127.0.0.11, for Podman: check /etc/resolv.conf in container
    resolver 10.89.0.1 ipv6=off;

    # Shared memory zones
    lua_shared_dict test_cache 10m;

    # Logging
    access_log /dev/stdout;

    # Default MIME types
    include /usr/local/openresty/nginx/conf/mime.types;
    default_type application/json;

    # Server configuration
    server {
        listen 8080;
        server_name localhost;

        # Health check endpoint
        location /health {
            content_by_lua_block {
                ngx.say('{"status":"ok"}')
            }
        }

        # Run all tests
        location /test {
            default_type text/plain;
            content_by_lua_file /app/nginx/lua/run_tests.lua;
        }

        # Test specific module
        location ~ ^/test/(.+)$ {
            default_type text/plain;
            set $test_module $1;
            content_by_lua_file /app/nginx/lua/run_module_test.lua;
        }

        # Interactive AQL query endpoint
        location /query {
            content_by_lua_file /app/nginx/lua/query.lua;
        }

        # API proxy to ArangoDB (for debugging)
        location /arangodb/ {
            proxy_pass http://arangodb:8529/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Documentation endpoint
        location /docs {
            default_type text/html;
            content_by_lua_block {
                ngx.say([[
<!DOCTYPE html>
<html>
<head><title>lua-arangodb Test Server</title></head>
<body>
<h1>lua-arangodb Test Server</h1>
<ul>
    <li><a href="/health">Health Check</a></li>
    <li><a href="/test">Run All Tests</a></li>
    <li><a href="/test/database">Test Database Module</a></li>
    <li><a href="/test/collection">Test Collection Module</a></li>
    <li><a href="/test/document">Test Document Module</a></li>
    <li><a href="/test/index">Test Index Module</a></li>
    <li><a href="/test/query">Test Query Module</a></li>
    <li><a href="/test/graph">Test Graph Module</a></li>
    <li><a href="/test/transaction">Test Transaction Module</a></li>
    <li><a href="/test/user">Test User Module</a></li>
    <li><a href="/test/admin">Test Admin Module</a></li>
    <li><a href="/test/analyzer">Test Analyzer Module</a></li>
    <li><a href="/test/view">Test View Module</a></li>
    <li><a href="/test/embeddings">Test Embeddings Module</a></li>
</ul>
</body>
</html>
                ]])
            }
        }

        # Default - show docs
        location / {
            return 302 /docs;
        }
    }
}
